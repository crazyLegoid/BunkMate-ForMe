<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>BunkMate</title>

<style>
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
}

header {
  padding: 16px;
  text-align: center;
  background: #020617;
  font-size: 22px;
  font-weight: 700;
}

main {
  padding: 16px;
  max-width: 480px;
  margin: auto;
}

form {
  background: #020617;
  padding: 16px;
  border-radius: 12px;
  margin-bottom: 20px;
}

form h2 {
  margin-bottom: 12px;
}

input {
  width: 100%;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 8px;
  border: none;
  background: #1e293b;
  color: white;
  font-size: 16px;
}

button {
  width: 100%;
  padding: 14px;
  border-radius: 10px;
  border: none;
  background: #2563eb;
  color: white;
  font-weight: 600;
}

button:active { opacity: 0.85; }

.subject {
  background: #020617;
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 14px;
}

.subject.safe { border-left: 6px solid #16a34a; }
.subject.warn { border-left: 6px solid #eab308; }
.subject.danger { border-left: 6px solid #dc2626; }

.subject h3 { margin: 0 0 6px; }

.meta { font-size: 14px; opacity: 0.9; }

.stats { font-size: 14px; line-height: 1.5; margin-top: 6px; }

.actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

.actions button {
  background: #334155;
  font-size: 14px;
  padding: 10px;
}

.sim { margin-top: 10px; }

.empty {
  text-align: center;
  opacity: 0.7;
  margin-top: 40px;
}
</style>
</head>

<body>
<header>BunkMate</header>

<main>
  <form id="subjectForm">
    <h2>Add Subject</h2>
    <input id="name" placeholder="Subject name" required />
    <input id="attended" type="number" min="0" placeholder="Classes attended" required />
    <input id="total" type="number" min="0" placeholder="Total classes conducted" required />
    <input id="minimum" type="number" min="1" max="100" placeholder="Minimum attendance %" />
    <button type="submit">Save Subject</button>
  </form>

  <div id="subjects"></div>
  <div id="empty" class="empty" style="display:none;">No subjects yet</div>
</main>

<script>
/* ================= STORAGE ================= */
const STORAGE_KEY = "bunkmate-db";

function loadDB() {
  const raw = localStorage.getItem(STORAGE_KEY);
  return raw ? JSON.parse(raw) : {
    settings: { defaultMinimumAttendance: 75 },
    subjects: []
  };
}

function saveDB(db) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
}

/* ================= MATH ================= */
function attendancePercent(a, t) {
  return t === 0 ? 100 : (a / t) * 100;
}

function bunksAllowed(a, t, m) {
  if (t === 0) return 0;
  return Math.max(0, Math.floor((a * 100 / m) - t));
}

function classesToRecover(a, t, m) {
  if (attendancePercent(a, t) >= m) return 0;
  return Math.ceil((m * t - 100 * a) / (100 - m));
}

function statusClass(p, m) {
  if (p < m) return "danger";
  if (p <= m + 5) return "warn";
  return "safe";
}

/* ================= RENDER ================= */
function render() {
  const db = loadDB();
  const container = document.getElementById("subjects");
  container.innerHTML = "";

  document.getElementById("empty").style.display =
    db.subjects.length ? "none" : "block";

  db.subjects.forEach(s => {
    const p = attendancePercent(s.attended, s.total);
    const card = document.createElement("div");

    card.className = `subject ${statusClass(p, s.minimumAttendance)}`;

    card.innerHTML = `
      <h3>${s.name}</h3>
      <div class="meta">${s.attended} / ${s.total} classes</div>
      <div class="stats">
        Attendance: ${p.toFixed(2)}%<br>
        Bunks allowed: ${bunksAllowed(s.attended, s.total, s.minimumAttendance)}<br>
        Classes to recover: ${classesToRecover(s.attended, s.total, s.minimumAttendance)}
      </div>

      <div class="sim">
        <input type="number" min="0" placeholder="Simulate next X classes">
        <div class="actions">
          <button onclick="window.simulate('${s.id}','attend',this)">Attend</button>
          <button onclick="window.simulate('${s.id}','bunk',this)">Bunk</button>
        </div>
      </div>

      <div class="actions">
        <button onclick="window.resetSubject('${s.id}')">Reset</button>
        <button onclick="window.deleteSubject('${s.id}')">Delete</button>
      </div>
    `;
    container.appendChild(card);
  });
}

/* ================= ACTIONS (GLOBAL) ================= */
window.simulate = function(id, type, btn) {
  const input = btn.closest(".sim").querySelector("input");
  const x = Number(input.value);
  if (!Number.isInteger(x) || x < 0) {
    alert("Enter a valid number");
    return;
  }

  const db = loadDB();
  const s = db.subjects.find(sub => sub.id === id);
  if (!s) return;

  let a = s.attended;
  let t = s.total;

  if (type === "attend") { a += x; t += x; }
  else { t += x; }

  const result = attendancePercent(a, t).toFixed(2);
  alert(`Resulting attendance: ${result}%`);
};

window.deleteSubject = function(id) {
  const db = loadDB();
  db.subjects = db.subjects.filter(s => s.id !== id);
  saveDB(db);
  render();
};

window.resetSubject = function(id) {
  const db = loadDB();
  const s = db.subjects.find(x => x.id === id);
  if (s) { s.attended = 0; s.total = 0; }
  saveDB(db);
  render();
};

/* ================= FORM ================= */
document.getElementById("subjectForm").addEventListener("submit", e => {
  e.preventDefault();
  const db = loadDB();

  const name = nameInput.value.trim();
  const attended = +attendedInput.value;
  const total = +totalInput.value;
  const min = minimumInput.value
    ? +minimumInput.value
    : db.settings.defaultMinimumAttendance;

  if (attended > total) return alert("Attended cannot exceed total");

  db.subjects.push({
    id: Date.now().toString(),
    name,
    attended,
    total,
    minimumAttendance: min
  });

  saveDB(db);
  e.target.reset();
  render();
});

/* ================= INIT ================= */
const nameInput = document.getElementById("name");
const attendedInput = document.getElementById("attended");
const totalInput = document.getElementById("total");
const minimumInput = document.getElementById("minimum");

render();
</script>
</body>
</html>